<section class="casts-list">
  <section class="stats summary" *ngIf="!!stats && summaryStats">
    <div class="aggregates basic">
      <div>Casts: {{ stats.castCount }}</div>
      <div>Total Damage: {{ stats.totalDamage }}</div>
      <div>Active DPS: {{ activeDps(stats) }} ({{stats.activeDuration }})</div>
    </div>

    <div class="aggregates detailed dots" *ngIf="stats.hasDotStats">
      <div>Avg per-cast DoT Downtime: {{ round(stats.dotStats.avgDowntime) }}s</div>
      <div *ngIf="targetId > 0">Total DoT Downtime: {{ round(stats.dotStats.totalDowntime) }}s</div>

      <div>Clipped DoTs: {{ round(stats.dotStats.clipCount) }}</div>
      <div>
        Clipped Ticks: {{ round(stats.dotStats.clippedTicks) }}
        ({{ round(stats.dotStats.missedTickPercent * 100, 2) }}%)
      </div>
    </div>

    <div class="aggregates detailed misc">
      <div *ngIf="stats.hasCooldownStats">Avg Time Off Cooldown: {{ round(stats.cooldownStats.avgOffCooldown) }}s</div>
      <div *ngIf="stats.hasChannelStats">Avg post-channel MF latency: {{ round(stats.channelStats.avgNextCastLatency) }}s</div>
    </div>

    <div class="aggregates spellpower">
      <div>Avg Spellpower: {{ round(stats.avgSpellpower) }}</div>
      <div>DPS/Power: {{ powerMetric(stats) }}</div>
    </div>
  </section>
  <section class="stats spell" *ngIf="!!stats && !!spellData">
    <div class="aggregates basic">
      <div>Casts: {{ stats.castCount }}</div>
      <div>Total Damage: {{ stats.totalDamage }}</div>
      <div>Active DPS: {{ activeDps(stats) }} ({{ stats.activeDuration }})</div>
      <div>Damage per Cast: {{ round(stats.avgDamage) }}</div>
    </div>

    <div class="aggregates hits" *ngIf="spellData.maxDamageInstances > 1">
      <div>Total Hits: {{ stats.totalHits }}</div>
      <div>Hits per Cast: {{ round(stats.avgHitCount) }}/{{ spellData.maxDamageInstances }}</div>
      <div>Avg Hit: {{ round(stats.avgHit) }}</div>

      <div *ngIf="stats.hasChannelStats">
        Avg Post-Channel Latency: {{ round(stats.channelStats.avgNextCastLatency) }}s
      </div>
    </div>

    <div class="aggregates dots" *ngIf="stats.hasDotStats">
        <div>Avg per-cast DoT Downtime: {{ round(stats.dotStats.avgDowntime) }}s</div>
        <div *ngIf="targetId > 0">Total DoT Downtime: {{ round(stats.dotStats.totalDowntime) }}s</div>
        <div>Clipped DoTs: {{ round(stats.dotStats.clipCount) }}</div>
        <div>
          Clipped Ticks: {{ round(stats.dotStats.clippedTicks) }}
          ({{ round(stats.dotStats.missedTickPercent * 100, 2) }}%)
        </div>
    </div>

    <div class="aggregates cooldown" *ngIf="stats.hasCooldownStats">
      <div>Avg Time off Cooldown: {{ round(stats.cooldownStats.avgOffCooldown) }}s</div>
      <div>Total Off Cooldown: {{ round(stats.cooldownStats.totalOffCooldown) }}s</div>
    </div>

    <div class="aggregates spellpower">
      <div>Avg Spellpower: {{ round(stats.avgSpellpower) }}</div>
      <div>DPS/Power: {{ powerMetric(stats) }}</div>
    </div>
  </section>

  <mat-accordion multi>
    <mat-expansion-panel *ngFor="let cast of casts" hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="cast-status" [ngClass]="statusClass(cast)"></span>
          <span class="timestamp table-accent">{{ offsetTime(cast.castEnd) }}</span>
          <span class="icon" [ngClass]="iconClass(cast)"></span>
          <span class="name spell-accent"> {{ cast.name }}</span>
          <span class="target"> {{ targetName(cast.targetId, cast.targetInstance) }}</span>
        </mat-panel-title>

        <mat-panel-description *ngIf="isDamage(cast)">
          <span class="downtime" *ngIf="spellId && isDot(cast)">Downtime: <span [ngClass]="downtimeClass(cast)">{{ round(cast.dotDowntime) }}</span></span>
          <span class="downtime" *ngIf="spellId && hasCooldown(cast)">Downtime: <span [ngClass]="downtimeClass(cast)">{{ round(cast.timeOffCooldown) }}</span></span>

          <span class="ticks" *ngIf="cast.ticks > 0">Hits: <span [ngClass]="tickClass(cast)">{{ cast.ticks }}/{{ expectedTicks(cast) }}</span></span>
          <span class="power">Power: <span class="table-accent">{{ cast.spellPower }}</span></span>
          <span class="damage">Damage: <span class="spell-accent">{{ cast.totalDamage }}</span></span>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <ng-template matExpansionPanelContent>
        <div class="stats">
          <div>Cast Time: {{ castTime(cast) }}s</div>
          <div *ngIf="cast.totalAbsorbed > 0">Absorbed: {{ cast.totalAbsorbed }}</div>
          <div *ngIf="cast.totalResisted > 0">Resisted: {{ cast.totalResisted }}</div>
          <div *ngIf="isDot(cast)">DoT downtime: <span [ngClass]="downtimeClass(cast)">{{ round(cast.dotDowntime) }}s</span></div>
          <div *ngIf="isDot(cast)">Clipped Previous: {{ cast.clippedPreviousCast }}</div>
          <div *ngIf="isChannel(cast)">Post-Channel latency: {{ round(cast.nextCastLatency) }}s</div>
          <div *ngIf="hasCooldown(cast)">Time off cooldown: <span [ngClass]="downtimeClass(cast)">{{ round(cast.timeOffCooldown) }}s</span></div>
        </div>

        <div class="instances" *ngIf="cast.instances.length > 0">
          Hits:
          <div class="instance" *ngFor="let instance of cast.instances">
            <span class="timestamp">{{ offsetTime(instance.timestamp) }}</span>
            <span class="damage">
              Damage: {{ instance.amount }}
              <span *ngIf="instance.partial">({{ instance.partialSummary }})</span>
            </span>
          </div>
        </div>
      </ng-template>
    </mat-expansion-panel>
  </mat-accordion>
</section>
