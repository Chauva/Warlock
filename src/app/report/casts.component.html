<section class="casts-list">
  <section class="stats" *ngIf="!!stats">
    <div class="casts">Casts: <span class="table-accent">{{ stats.castCount }}</span></div>
    <div class="damage">Damage: <span class="table-accent">{{ stats.totalDamage }}</span></div>
    <div class="dps">Active DPS: <span class="table-accent">{{ activeDps(stats) }}</span></div>
    <div class="time">Active Time: <span class="table-accent">{{ duration(stats.activeDuration, 'M:ss') }}</span></div>
    <div class="break basic hidden"></div>

    <ng-container *ngIf="spellData && spellData.maxDamageInstances > 1">
      <div class="avg-cast">Avg Cast: <span class="table-accent">{{ format(stats.avgDamage) }}</span></div>
      <div class="hits">Hits: <span class="table-accent">{{ stats.totalHits }}</span></div>
      <div class="avg-hits">Hits/Cast: <span class="table-accent">{{ format(stats.avgHitCount) }}/{{ spellData.maxDamageInstances }}</span></div>
      <div class="avg-hit">Avg Hit: <span class="table-accent">{{ format(stats.avgHit) }}</span></div>
      <div class="break hits hidden"></div>
    </ng-container>

    <ng-container *ngIf="stats.hasClipStats">
      <div class="avg-downtime">
        Avg DoT Downtime:
        <span [ngClass]="highlight.dotDowntime(stats)">
          {{ format(stats.dotDowntimeStats.avgDowntime, 1, 's') }}
        </span>
      </div>
      <div class="total-downtime" *ngIf="targetId > 0">
        Total DoT Downtime:
        <span class="table-accent">{{ format(stats.dotDowntimeStats.totalDowntime, 1, 's') }}</span>
      </div>
      <div class="clipped-dots">
        Clipped DoTs:
        <span [ngClass]="highlight.clippedTicks(stats)">{{ stats.clipStats.clipCount }}</span>
      </div>
      <div class="clipped-ticks">
        Clipped Ticks:
        <span [ngClass]="highlight.clippedTicks(stats)">
          {{ stats.clipStats.clippedTicks }}
          ({{ format(stats.clipStats.missedTickPercent * 100, 2) }}%)
        </span>
      </div>
      <div class="break clipped-ticks" [ngClass]="{ 'hidden': targetId > 0 }"></div>
    </ng-container>

    <ng-container *ngIf="stats.hasCooldownStats">
      <div class="avg-cast" *ngIf="spellData">
        Avg Cast:
        <span class="table-accent">{{ format(stats.avgDamage) }}</span>
      </div>
      <div class="avg-cooldown">
        Avg Off Cooldown:
        <span [ngClass]="highlight.cooldown(stats)">{{ format(stats.cooldownStats.avgOffCooldown, 1, 's') }}</span>
      </div>
      <div class="total-cooldown" *ngIf="spellData">
        Total Off Cooldown:
        <span class="table-accent">{{ format(stats.cooldownStats.totalOffCooldown, 1, 's') }}</span>
      </div>
    </ng-container>

    <div class="avg-latency" *ngIf="stats.hasChannelStats">
      Avg MF latency:
      <span [ngClass]="highlight.latency(stats)">
        {{ format(stats.channelStats.avgNextCastLatency, 2, 's') }}
      </span>
    </div>

    <div class="break spellpower" [ngClass]="{ 'hidden': stats.hasChannelStats }"></div>
    <div class="avg-spellpower">Avg Spellpower: <span class="table-accent">{{ format(stats.avgSpellpower) }}</span></div>
    <div class="power-metric">DPS/Power: <span class="table-accent">{{ powerMetric(stats) }}</span></div>
  </section>

  <section class="spell-filter">
    <div class="filters">
      <mat-form-field class="fill" appearance="standard" *ngIf="filterSpells">
        <mat-label>Filter Spells</mat-label>
        <mat-select [formControl]="spellFilter" multiple>
          <mat-select-trigger>
            <ng-container *ngIf="spellFilter.value && spellFilter.value.length < 3">
              {{ getSpellNames(spellFilter.value) }}
            </ng-container>
            <ng-container *ngIf="spellFilter.value?.length >= 3 && spellFilter.value?.length !== spells.length">
              {{ spellFilter.value.length }} spells
            </ng-container>
          </mat-select-trigger>
          <mat-option *ngFor="let option of spells" [value]="option.id">
            {{option.name}}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="help">
      <a href="https://github.com/thewellnamed/shadow/blob/main/GLOSSARY.md" target="_blank">Glossary</a>
    </div>
  </section>

  <mat-accordion multi>
    <mat-expansion-panel *ngFor="let cast of casts" hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="cast-status" [ngClass]="highlight.overall(cast)"></span>
          <span class="timestamp table-accent">{{ offsetTime(cast.castEnd) }}</span>
          <span class="icon" [ngClass]="iconClass(cast)"></span>
          <span class="name spell-accent" [ngClass]="{ 'no-target': !cast.targetId }">{{ cast.name }}</span>
          <span class="target"> {{ targetName(cast.targetId, cast.targetInstance) }}</span>
        </mat-panel-title>

        <mat-panel-description *ngIf="isDamage(cast)">
          <span class="downtime" *ngIf="spellId && isDot(cast)">
            <span class="downtime-label">Downtime: </span>
            <span [ngClass]="highlight.dotDowntime(cast)">{{ format(cast.dotDowntime) }}</span>
          </span>
          <span class="cooldown" *ngIf="spellId && hasCooldown(cast)">
            <span class="downtime-label">Downtime: </span>
            <span class="cd-label">CD: </span>
            <span [ngClass]="highlight.cooldown(cast)">{{ format(cast.timeOffCooldown) }}</span>
          </span>

          <span class="hits" *ngIf="expectHits(cast)" [ngClass]="{ 'failed': cast.failed }">
            <span class="hits-label">Hits: </span>
            <span class="hits-label-abbrev">H: </span>
            <span [ngClass]="highlight.hits(cast)">{{ hits(cast) }}</span>
          </span>
          <span class="power">Power: <span class="table-accent">{{ cast.spellPower }}</span></span>
          <span class="damage" *ngIf="!cast.failed">
            <span class="damage-label">Damage: </span>
            <span class="spell-accent">{{ cast.totalDamage }}</span>
          </span>
          <span class="damage" *ngIf="cast.resisted"><span class="text-warning">Resisted</span></span>
          <span class="damage" *ngIf="cast.immune"><span class="text-warning">Immune</span></span>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <ng-template matExpansionPanelContent>
        <span class="cast-status" [ngClass]="highlight.overall(cast)"></span>
        <div class="cast-details">
          <div>Cast Time: {{ castTime(cast) }}s</div>
          <div class="spellpower hidden">Spellpower: {{ cast.spellPower }}</div>
          <div class="hits hidden" *ngIf="expectHits(cast)">
            Hits:
            <span [ngClass]="highlight.hits(cast)">{{ hits(cast) }}</span>
          </div>
          <div *ngIf="cast.totalAbsorbed > 0">Absorbed: {{ cast.totalAbsorbed }}</div>
          <div *ngIf="cast.totalResisted > 0">Resisted: {{ cast.totalResisted }}</div>
          <div *ngIf="isDot(cast)">
            DoT downtime:
            <span [ngClass]="highlight.dotDowntime(cast)">{{ format(cast.dotDowntime, 1, 's') }}</span>
          </div>
          <div *ngIf="isDot(cast)">
            Clipped Previous:
            <span [ngClass]="highlight.clippedCast(cast)">{{ cast.clippedPreviousCast }}</span></div>
          <div *ngIf="isChannel(cast)">
            Post-Channel latency:
            <span [ngClass]="highlight.latency(cast)">{{ format(cast.nextCastLatency, 2, 's') }}</span>
          </div>
          <div *ngIf="hasCooldown(cast)">
            Time off cooldown:
            <span [ngClass]="highlight.cooldown(cast)">{{ format(cast.timeOffCooldown, 1, 's') }}</span>
          </div>
          <div *ngIf="cast.truncated">Truncated: <span [ngClass]="highlight.hits(cast)">true</span></div>
        </div>

        <div class="instances" *ngIf="cast.dealtDamage">
          Hits:
          <div class="instance" *ngFor="let instance of cast.instances">
            <span class="timestamp">{{ offsetTime(instance.timestamp) }}</span>
            <span class="damage">
              Damage: {{ instance.amount }}
              <span *ngIf="instance.partial">({{ instance.partialSummary }})</span>
            </span>
          </div>
        </div>
      </ng-template>
    </mat-expansion-panel>
    <mat-expansion-panel *ngIf="spellData && casts.length === 0" class="text-notice" disabled>
      <mat-expansion-panel-header>
        No casts found. Are you using max rank?
      </mat-expansion-panel-header>
    </mat-expansion-panel>
  </mat-accordion>

</section>
